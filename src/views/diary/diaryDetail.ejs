<!-- 김서영_60221302_고급웹final -->

<!DOCTYPE html>
<html lang="ko">
  <link rel="stylesheet" href="../css/diaryDetail.css" />
  <head>
    <meta charset="UTF-8" />
    <title><%= diary.title %> - 다이어리</title>
  </head>

  <body>
    <h2><%= diary.title %></h2>
    <p><%= diary.description %></p>

    <hr />

    <!-- 멤버 목록 -->
    <h3>멤버</h3>
    <ul>
      <% diary.DiaryMembers.forEach(m => { %>
      <li><%= m.User.nick %> (<%= m.role %>)</li>
      <% }) %>
    </ul>

    <hr />
    <div class="action-buttons">
      <% if (diary.DiaryMembers.some(m => m.userId === user.id && m.role ===
      "owner")) { %>
      <a href="/diary/<%= diary.id %>/members" class="manage-btn"
        >가입 요청 관리</a
      >
      <% } %> <% if (isMember) { %>
      <a href="/post/create/<%= diary.id %>" class="write-btn">+ 일기쓰기</a>
      <% } %>
    </div>

    <hr />

    <!-- 게시글 목록 -->
    <h3>일기</h3>

    <div class="posts-container">
      <% diary.Posts.forEach(post => { %>
      <div class="post-card <%= post.userId === user.id ? 'my-post' : '' %>">
        <div class="post-header">
          <span class="author"><%= post.User.nick %></span>
          <div class="right-area">
            <span class="date"><%= post.createdAt.toLocaleString() %></span>

            <% if (post.userId === user.id) { %>
            <button class="edit-btn">수정</button>
            <button class="delete-btn">삭제</button>
            <% } %>
          </div>
        </div>
        <h4 class="post-title"><%= post.title %></h4>

        <div
          class="post-content"
          data-post-id="<%= post.id %>"
          data-is-owner="<%= post.userId === user.id %>"
        >
          <!-- 보기 모드 -->
          <div class="content-view">
            <%- post.content.replace(/\n/g, "<br />") %>
          </div>

          <!-- 수정 모드 -->
          <textarea class="content-edit hidden"><%= post.content %></textarea>

          <div class="edit-buttons hidden">
            <button class="save-btn">저장</button>
            <button class="cancel-btn">취소</button>
          </div>
        </div>
      </div>

      <% }) %>
    </div>

    <hr />
  </body>
  <script>
    document.querySelectorAll(".post-content").forEach((box) => {
      const isOwner = box.dataset.isOwner === "true";
      if (!isOwner) return;

      const view = box.querySelector(".content-view");
      const edit = box.querySelector(".content-edit");
      const editBtn = box.parentElement.querySelector(".edit-btn");
      const buttons = box.querySelector(".edit-buttons");
      const deleteBtn = box.parentElement.querySelector(".delete-btn");
      const postId = box.dataset.postId;

      //  수정 버튼 클릭 → 수정 모드로 전환
      editBtn.addEventListener("click", () => {
        view.classList.add("hidden");
        editBtn.classList.add("hidden");
        edit.classList.remove("hidden");
        buttons.classList.remove("hidden");
        edit.focus();
      });

      //  취소 버튼 → 다시 보기 모드
      buttons.querySelector(".cancel-btn").addEventListener("click", () => {
        edit.classList.add("hidden");
        buttons.classList.add("hidden");
        view.classList.remove("hidden");
        editBtn.classList.remove("hidden");

        // 원래 내용 복구
        edit.value = view.innerHTML.replace(/<br\s*\/?>/g, "\n");
      });

      //  저장 → 서버로 PUT 요청
      buttons.querySelector(".save-btn").addEventListener("click", async () => {
        const newContent = edit.value;

        const res = await fetch(`/post/${postId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: newContent }),
        });

        if (res.ok) {
          // 화면에 반영
          view.innerHTML = newContent.replace(/\n/g, "<br />");
          edit.classList.add("hidden");
          buttons.classList.add("hidden");
          view.classList.remove("hidden");
          editBtn.classList.remove("hidden");
        } else {
          alert("수정 실패");
        }
      });

      //  삭제 버튼 → 서버로 DELETE 요청
      deleteBtn.addEventListener("click", async () => {
        if (!confirm("정말 삭제할까요?")) return;

        const res = await fetch(`/post/${postId}`, {
          method: "DELETE",
          credentials: "include",
        });

        if (res.ok) {
          // DOM에서 카드 삭제
          box.parentElement.remove();
        } else {
          alert("삭제 실패");
        }
      });
    });
  </script>
</html>
